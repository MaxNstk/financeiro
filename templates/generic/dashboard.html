{% extends 'generic/charts.html' %}
{% load crispy_forms_tags %}

{% block page-title %} Dashboard {% endblock %}

{% block pre_charts  %}
    {% crispy form %}
{% endblock %}


{% block chart1 %}
    <div class="card-header">
        <i class="fas fa-chart-area me-1"></i>
        Gráficos de Valores por Categoria
    </div>
    <div class="card-body">
        <canvas id="transactionsChart" width="50%" height="50%"> </canvas>
    </div>
{% endblock %}

{% block chart2 %}
    <div class="card-header">
        <i class="fas fa-chart-bar me-1"></i>
        Gráficos de Valores por Categoria
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table">
                <thead>
                <tr>
                    <td>
                        <b>Valor Total: R${{ total_value }}</b>
                    </td>
                </tr>
                </thead>
                <tbody>
                {% for category in categories %}
                    <tr>
                        <td>
                            {{category.name.title }} : {{ category.percentage }}%  ----  R${{ category.value }}
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>

        </div>
    </div>
{% endblock chart2 %}

{% block pre_charts2 %}
            {% crispy category_filter_form %}
{% endblock %}

{% block chart3 %}
    <div class="card-header">
        <i class="fas fa-chart-area me-1"></i>
        <b id="chart3-title">Gráfico para Categorias</b>
    </div>
    <div class="card-body">
        <canvas id="categoriesChart" width="50%" height="50%"> </canvas>
    </div>
{% endblock %}

{% block scripts %}

     <script>

        var ctx = document.getElementById('transactionsChart');
        var categories_names = JSON.parse('{{ categories_names|safe }}');
        var categories_values = JSON.parse('{{ categories_values|safe }}');
        var categories_percentages = JSON.parse('{{ categories_percentages|safe }}');

        var transactionsChart = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: categories_names,
                datasets: [{
                    label: 'Pizza',
                    data: categories_values,
                    backgroundColor: [
                        'rgb(255, 99, 132)',
                        'rgb(54, 162, 235)',
                        'rgb(255, 205, 86)'
                    ],
                    hoverOffset: 4
                }]
            },
        });
    </script>


    <script>
    $("#category_filter_submit").click(function (){
        let filterParams = {
            category : $("#id_cat_category").val(),
            initialDate : $("#id_cat_initial_date").val(),
            finalDate : $("#id_cat_final_date").val(),
            valueLte : $("#id_cat_value_lte").val(),
            valueGte : $("#id_cat_value_gte").val(),
            type : $("#id_cat_type").val(),
        };
        $.ajax({
            url : '{% url 'charts:filter_categoriees' %}',
            method: 'get',
            data: filterParams,
            success: (response) => {
                var chart = document.getElementById('categoriesChart')

                var category = response.category;
                var values = response.values;
                var dates = response.dates;

                document.getElementById('chart3-title').innerHTML= 'Grafico de gastos em: '+category
                var categoriesChart = new Chart(chart, {
            type: 'pie',
            data: {
                labels: dates,
                datasets: [{
                    label: 'Pizza',
                    data: values,
                    backgroundColor: [
                        'rgb(255, 99, 132)',
                        'rgb(54, 162, 235)',
                        'rgb(255, 205, 86)'
                    ],
                    hoverOffset: 4
                }]
            },
        });

                console.log('deu boa')
            },
            error: function(){
                console.log('não deu boa')
            }
        })

    });
    </script>

    <script>
        $('#id_category').select2({
            placeholder: 'Selecione uma ou mais Categorias'
        })

    </script>
{% endblock %}